#!/usr/bin/make -f
# See debhelper(7) (uncomment to enable)
# output every command that modifies files on the build system.
DH_VERBOSE = 1
 
include /usr/share/cdbs/1/rules/debhelper.mk
include /usr/share/cdbs/1/class/qmake.mk

# see FEATURE AREAS in dpkg-buildflags(1)
#export DEB_BUILD_MAINT_OPTIONS = hardening=+all
 
PATH := /home/abuild/.local/bin/:$(PATH)

export DESTROOT=$(CURDIR)/debian/kanidm
# see ENVIRONMENT in dpkg-buildflags(1)
# package maintainers to append CFLAGS
#export DEB_CFLAGS_MAINT_APPEND  = -Wall -pedantic
# package maintainers to append LDFLAGS
#export DEB_LDFLAGS_MAINT_APPEND = -Wl,--as-needed

%:
	mkdir -p ~/.cargo/
	echo '[source.crates-io]' > ~/.cargo/config.toml
	echo 'replace-with = "vendored-sources"' >> ~/.cargo/config.toml
	echo '[source.vendored-sources]' >> ~/.cargo/config.toml
	echo "directory = \"/tmp/rust-vendor/\"" >> ~/.cargo/config.toml
	mkdir -p "/tmp/rust-vendor/"
	tar -xzf "/usr/src/packages/SOURCES/vendor.tar.gz" --directory "/tmp/rust-vendor/"
	cat ~/.cargo/config.toml

	tar -zxf "/usr/src/packages/SOURCES/rust-1.52.1-x86_64-unknown-linux-gnu.tar.gz" --directory "/tmp"
	chmod +x /tmp/rust-1.52.1-x86_64-unknown-linux-gnu/*
	mkdir -p ~/.local
	/tmp/rust-1.52.1-x86_64-unknown-linux-gnu/install.sh --disable-ldconfig --prefix=~/.local/ --without=rust-docs,clippy-preview,rust-analyzer-preview,miri-preview,rustfmt-preview,rls-preview
	rustc --version
	cargo build --release --bin kanidm
	echo "done building!"

	echo "Copying kanidm to $(DESTROOT)/usr/local/sbin/kanidm"
	install -p -D -m 0755 target/release/kanidm $(DESTROOT)/usr/local/sbin/kanidm
	echo "Removing target/"
	rm -rf target
	echo '##################################################'
	echo "Done on yale's terrible script"
	echo '##################################################'


